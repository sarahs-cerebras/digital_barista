<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cerebras Capacity Estimator</title>
    <style>
      :root {
        --bg-primary: #f5f5f7;
        --bg-secondary: #ffffff;
        --bg-tertiary: #f5f5f7;
        --bg-card: #ffffff;
        --text-primary: rgb(43, 25, 16);
        --text-secondary: #86868b;
        --border-color: rgba(0, 0, 0, 0.08);
        --accent-color: rgb(224, 100, 57);
        --accent-hover: rgb(200, 85, 45);
        --success-color: #34c759;
        --warning-color: #ff9500;
        --error-color: #ff3b30;
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.12);
        --radius-sm: 8px;
        --radius-md: 12px;
        --radius-lg: 16px;
      }
      [data-theme="dark"] {
        --bg-primary: #000000;
        --bg-secondary: #1c1c1e;
        --bg-tertiary: #2c2c2e;
        --bg-card: #2c2c2e;
        --text-primary: #f5f5f7;
        --text-secondary: #86868b;
        --border-color: rgba(255, 255, 255, 0.1);
        --accent-color: rgb(224, 100, 57);
        --accent-hover: rgb(240, 115, 70);
        --success-color: #30d158;
        --warning-color: #ff9f0a;
        --error-color: #ff453a;
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
        --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.5);
      }
      * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", "Segoe UI", Roboto, sans-serif; -webkit-font-smoothing: antialiased; }
      body { background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; padding: 40px 20px; transition: background 0.3s ease, color 0.3s ease; }
      .container { max-width: 800px; margin: 0 auto; }
      .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; }
      .logo { display: flex; align-items: center; gap: 12px; }
      .logo-img { height: 24px; width: auto; opacity: 0.9; }
      .logo-icon { width: 40px; height: 40px; background: linear-gradient(135deg, var(--accent-color), var(--accent-hover)); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 20px; color: white; display: none; }
      .logo-text h1 { font-size: 24px; font-weight: 600; letter-spacing: -0.5px; }
      .logo-text p { font-size: 14px; color: var(--text-secondary); margin-top: 2px; }
      .theme-toggle { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 20px; padding: 6px; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.3s ease; box-shadow: var(--shadow-sm); }
      .theme-toggle:hover { box-shadow: var(--shadow-md); }
      .theme-toggle svg { width: 18px; height: 18px; color: var(--text-secondary); transition: color 0.3s ease; }
      .card { background: var(--bg-secondary); border-radius: var(--radius-lg); padding: 32px; box-shadow: var(--shadow-md); margin-bottom: 24px; transition: background 0.3s ease, box-shadow 0.3s ease; }
      .card:hover { box-shadow: var(--shadow-lg); }
      .card-title { font-size: 20px; font-weight: 600; margin-bottom: 24px; letter-spacing: -0.3px; }
      .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
      .form-group { margin-bottom: 20px; }
      .form-group.full-width { grid-column: 1 / -1; }
      label { display: block; font-size: 13px; font-weight: 500; color: var(--text-secondary); margin-bottom: 8px; letter-spacing: -0.2px; }
      input, select, textarea { width: 100%; padding: 14px 16px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: var(--radius-md); color: var(--text-primary); font-size: 16px; font-weight: 400; transition: all 0.2s ease; appearance: none; }
      textarea { min-height: 80px; resize: vertical; font-family: inherit; }
      input:focus, select:focus, textarea:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 4px rgba(224, 100, 57, 0.1); }
      input::placeholder, textarea::placeholder { color: var(--text-secondary); }
      select { cursor: pointer; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2386868b' d='M6 8L1 3h10z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 16px center; padding-right: 40px; }
      .button { width: 100%; padding: 16px; background: var(--accent-color); color: white; border: none; border-radius: var(--radius-md); font-size: 17px; font-weight: 500; cursor: pointer; transition: all 0.2s ease; letter-spacing: -0.3px; }
      .button:hover { background: var(--accent-hover); transform: translateY(-1px); box-shadow: var(--shadow-md); }
      .button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
      .button-secondary { background: var(--accent-color); }
      .button-secondary:hover { background: var(--accent-hover); }
      .results { display: none; animation: fadeIn 0.4s ease; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
      .results-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
      .result-item { background: var(--bg-tertiary); border-radius: var(--radius-md); padding: 20px; transition: background 0.3s ease; }
      .result-item.full-width { grid-column: 1 / -1; }
      .result-label { font-size: 13px; font-weight: 500; color: var(--text-secondary); margin-bottom: 8px; letter-spacing: -0.2px; }
      .result-value { font-size: 28px; font-weight: 600; color: var(--text-primary); letter-spacing: -0.5px; }
      .result-value.highlight { color: var(--success-color); }
      .disclaimer { margin-top: 24px; padding: 16px; background: var(--bg-tertiary); border-radius: var(--radius-md); font-size: 13px; color: var(--text-secondary); line-height: 1.5; border-left: 3px solid var(--accent-color); }
      .ticket-section { display: none; animation: fadeIn 0.4s ease; }
      .alert { padding: 16px; border-radius: var(--radius-md); margin-bottom: 20px; font-size: 14px; }
      .alert-success { background: rgba(52, 199, 89, 0.1); border: 1px solid var(--success-color); color: var(--success-color); }
      .alert-error { background: rgba(255, 59, 48, 0.1); border: 1px solid var(--error-color); color: var(--error-color); }
      .alert a { color: inherit; font-weight: 600; }
      .footer { text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid var(--border-color); }
      .footer p { font-size: 13px; color: var(--text-secondary); }
      .loading { display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: white; animation: spin 0.8s linear infinite; margin-right: 8px; }
      @keyframes spin { to { transform: rotate(360deg); } }
      .toggle-switch { position: relative; display: inline-block; width: 44px; height: 24px; flex-shrink: 0; }
      .toggle-switch input { opacity: 0; width: 0; height: 0; }
      .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: 0.3s; border-radius: 24px; }
      .toggle-slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: 0.3s; border-radius: 50%; }
      .toggle-switch input:checked + .toggle-slider { background-color: var(--accent-color); }
      .toggle-switch input:checked + .toggle-slider:before { transform: translateX(20px); }
      @media (max-width: 600px) { .form-grid { grid-template-columns: 1fr; } .results-grid { grid-template-columns: 1fr; } .card { padding: 24px; } .result-value { font-size: 24px; } }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div class="logo">
          <img id="logoImg" class="logo-img" src="" alt="Cerebras" />
          <div class="logo-text"><p style="font-size: 16px; font-weight: 500;">Capacity Estimator</p></div>
        </div>
        <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme">
          <svg id="sunIcon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
          <svg id="moonIcon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="display: none"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg>
        </button>
      </div>
      <div class="card">
        <h2 class="card-title">Configuration</h2>
        <div class="form-grid">
          <div class="form-group full-width"><label for="model">Model Architecture</label><select id="model"><option value="">Loading models...</option></select></div>
          <div class="form-group"><label for="inputTokens">Input Tokens</label><input type="number" id="inputTokens" placeholder="1000" min="0" /></div>
          <div class="form-group"><label for="outputTokens">Output Tokens</label><input type="number" id="outputTokens" placeholder="500" min="0" /></div>
          <div class="form-group"><label for="cachedTokens">Cached Tokens</label><input type="number" id="cachedTokens" placeholder="200" min="0" /></div>
          <div class="form-group"><label for="requestsPerMinute">Requests per Minute</label><input type="number" id="requestsPerMinute" placeholder="100" min="1" /></div>
        </div>
        <button class="button" onclick="calculate()">Calculate Capacity</button>
      </div>
      <div class="card results" id="results">
        <h2 class="card-title">Results</h2>
        <div class="results-grid">
          <div class="result-item"><div class="result-label">Current Utilization</div><div class="result-value" id="currentUtilization">-</div></div>
          <div class="result-item"><div class="result-label">Available Capacity</div><div class="result-value" id="availableCapacity">-</div></div>
          <div class="result-item"><div class="result-label">Required TPM</div><div class="result-value highlight" id="requiredTPM">-</div></div>
          <div class="result-item"><div class="result-label">Systems Needed</div><div class="result-value highlight" id="systemsNeeded">-</div></div>
          <div class="result-item full-width"><div class="result-label">Estimated Total System TPM</div><div class="result-value highlight" id="totalTPM">-</div></div>
        </div>
        <div class="disclaimer"><strong>Note:</strong> Estimates are within ¬±20% accuracy. This tool provides quick estimates for customer conversations.</div>
      </div>
      <div class="card ticket-section" id="ticketSection">
        <h2 class="card-title">Create Rate Limit Request</h2>
        <p style="margin-bottom: 16px; font-size: 13px; color: var(--text-secondary);">View existing tickets: <a href="https://cerebras.atlassian.net/issues/?filter=30285" target="_blank" style="color: var(--accent-color);">CUST Board</a></p>
        <div id="ticketAlert"></div>
        <div class="form-grid">
          <div class="form-group"><label for="customerName">Customer Name *</label><input type="text" id="customerName" placeholder="Acme Corp" required /></div>
          <div class="form-group"><label for="orgId">Org ID</label><input type="text" id="orgId" placeholder="org_abc123xyz" /></div>
          <div class="form-group"><label for="engagementType">Engagement Type *</label><select id="engagementType"><option value="trial">Trial</option><option value="paygo">PAYGO</option><option value="committed">Committed</option></select></div>
          <div class="form-group"><label for="timezoneRegion">Timezone Region</label><select id="timezoneRegion"><option value="">Select...</option><option value="us">US</option><option value="europe">Europe (CET, EET, etc.)</option><option value="apac">APAC (IST, SGT, JST, etc.)</option></select></div>
          <div class="form-group"><label for="workloadWindow">Workload Window</label><select id="workloadWindow"><option value="">Select...</option><option value="all_day">All Day</option><option value="daytime">Daytime</option><option value="nighttime">Nighttime</option></select></div>
          <div class="form-group"><label for="plannedStart">Planned Start *</label><input type="date" id="plannedStart" required /></div>
          <div class="form-group"><label for="durationDays">Duration (days)</label><input type="number" id="durationDays" placeholder="30" min="1" /></div>
          <div class="form-group full-width"><label for="notes">Notes</label><textarea id="notes" placeholder="Additional context or requirements..."></textarea></div>
          <div class="form-group full-width" style="display: flex; align-items: center; gap: 12px;">
            <label class="toggle-switch"><input type="checkbox" id="testMode" /><span class="toggle-slider"></span></label>
            <span style="font-size: 14px; color: var(--text-secondary);">üß™ Test mode (updates CUST-506) ‚Äî enable to test without creating real ticket</span>
          </div>
        </div>
        <button class="button button-secondary" onclick="createTicket()" id="createTicketBtn">Create Jira Ticket</button>
      </div>
      <div class="footer"><p>Built with ‚ù§Ô∏è by Ecosystem Engineering ‚Ä¢ Shared Endpoint Capacity Planning</p></div>
    </div>
    <script>
      let modelData = {};
      let lastCalculation = null;
      async function loadModels() {
        try {
          const response = await fetch('/api/models');
          if (!response.ok) throw new Error('Failed to load models');
          modelData = await response.json();
          const select = document.getElementById('model');
          select.innerHTML = '';
          for (const modelName of Object.keys(modelData)) {
            const option = document.createElement('option');
            option.value = modelName;
            option.textContent = modelName;
            select.appendChild(option);
          }
        } catch (error) {
          console.error('Error loading models:', error);
          modelData = {"gpt-oss-120b":{replicas:7,systems:49,deployedCapacity:376138,tokenUsage7d:90426011290,utilization:52.24,totalTokenCapacity:173098400000},"qwen-3-235b-a22b-instruct-2507":{replicas:2,systems:28,deployedCapacity:69326,tokenUsage7d:18151815294,utilization:50.99,totalTokenCapacity:35600000000},"llama3.1-8b":{replicas:2,systems:2,deployedCapacity:39682,tokenUsage7d:8490952351,utilization:36.76,totalTokenCapacity:23100000000},"llama-3.3-70b":{replicas:2,systems:18,deployedCapacity:135854,tokenUsage7d:29187009113,utilization:35.59,totalTokenCapacity:82000000000},"qwen-3-32b":{replicas:4,systems:24,deployedCapacity:73886,tokenUsage7d:12246624063,utilization:32.03,totalTokenCapacity:38240000000},"zai-glm-4.6":{replicas:1,systems:24,deployedCapacity:95599,tokenUsage7d:15712457657,utilization:28.87,totalTokenCapacity:54433333333}};
          const select = document.getElementById('model');
          select.innerHTML = '';
          for (const modelName of Object.keys(modelData)) {
            const option = document.createElement('option');
            option.value = modelName;
            option.textContent = modelName;
            select.appendChild(option);
          }
        }
      }
      function formatNumber(num) {
        if (num >= 1000000000) return (num / 1000000000).toFixed(2) + "B";
        if (num >= 1000000) return (num / 1000000).toFixed(2) + "M";
        if (num >= 1000) return (num / 1000).toFixed(2) + "K";
        return num.toFixed(2);
      }
      async function calculate() {
        const model = document.getElementById("model").value;
        const inputTokens = parseFloat(document.getElementById("inputTokens").value) || 0;
        const outputTokens = parseFloat(document.getElementById("outputTokens").value) || 0;
        const cachedTokens = parseFloat(document.getElementById("cachedTokens").value) || 0;
        const requestsPerMinute = parseFloat(document.getElementById("requestsPerMinute").value) || 0;
        if (requestsPerMinute <= 0) { alert("Please enter a valid requests per minute value"); return; }
        const data = modelData[model];
        if (!data) { alert("Please select a valid model"); return; }
        const totalTokensPerRequest = inputTokens + outputTokens + cachedTokens;
        const tokensPerMinute = totalTokensPerRequest * requestsPerMinute;
        const availableCapacity = data.totalTokenCapacity * (1 - data.utilization / 100);
        const requiredTPM = tokensPerMinute;
        const systemsPerTPM = data.systems / data.deployedCapacity;
        const systemsNeeded = Math.ceil(requiredTPM * systemsPerTPM);
        const totalTPM = systemsNeeded * (data.deployedCapacity / data.systems);
        lastCalculation = { model, inputTokens, outputTokens, cachedTokens, requestsPerMinute, requiredTPM, systemsNeeded, totalTPM };
        document.getElementById("currentUtilization").textContent = data.utilization.toFixed(2) + "%";
        document.getElementById("availableCapacity").textContent = formatNumber(availableCapacity) + " tokens/day";
        document.getElementById("requiredTPM").textContent = formatNumber(requiredTPM) + " TPM";
        document.getElementById("systemsNeeded").textContent = systemsNeeded;
        document.getElementById("totalTPM").textContent = formatNumber(totalTPM) + " TPM";
        document.getElementById("results").style.display = "block";
        document.getElementById("ticketSection").style.display = "block";
      }
      async function createTicket() {
        if (!lastCalculation) { alert("Please calculate capacity first"); return; }
        const customerName = document.getElementById("customerName").value.trim();
        const orgId = document.getElementById("orgId").value.trim();
        const engagementType = document.getElementById("engagementType").value;
        const timezoneRegion = document.getElementById("timezoneRegion").value || null;
        const workloadWindow = document.getElementById("workloadWindow").value || null;
        const plannedStart = document.getElementById("plannedStart").value;
        const durationDays = parseInt(document.getElementById("durationDays").value) || null;
        const notes = document.getElementById("notes").value.trim();
        
        if (!customerName || !plannedStart) { 
          alert("Please fill in Customer Name and Planned Start"); 
          return; 
        }
        
        const btn = document.getElementById("createTicketBtn");
        btn.disabled = true;
        btn.innerHTML = '<span class="loading"></span>Creating ticket...';
        const alertDiv = document.getElementById("ticketAlert");
        alertDiv.innerHTML = '';
        
        // Format planned start as ISO datetime
        const plannedStartISO = new Date(plannedStart + "T09:00:00").toISOString();
        
        try {
          const response = await fetch('/api/create-ticket', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              customer_name: customerName,
              org_id: orgId || null,
              model_id: lastCalculation.model,
              engagement_type: engagementType,
              timezone_region: timezoneRegion,
              workload_window: workloadWindow,
              planned_start: plannedStartISO,
              duration_days: durationDays,
              notes: notes || null,
              test_mode: document.getElementById("testMode").checked,
            }),
          });
          const result = await response.json();
          if (result.success) {
            alertDiv.innerHTML = `<div class="alert alert-success">‚úì Ticket created: <a href="${result.ticket_url}" target="_blank">${result.ticket_key}</a></div>`;
          } else {
            alertDiv.innerHTML = `<div class="alert alert-error">‚úó Failed: ${result.error}</div>`;
          }
        } catch (error) {
          alertDiv.innerHTML = `<div class="alert alert-error">‚úó Error: ${error.message}</div>`;
        } finally {
          btn.disabled = false;
          btn.innerHTML = 'Create Jira Ticket';
        }
      }
      function updateLogo(theme) {
        const logoImg = document.getElementById("logoImg");
        logoImg.src = theme === "dark" ? "/assets/logo-dark-mode.png" : "/assets/logo-light-mode.png";
      }
      function toggleTheme() {
        const html = document.documentElement;
        const currentTheme = html.getAttribute("data-theme");
        const newTheme = currentTheme === "dark" ? "light" : "dark";
        html.setAttribute("data-theme", newTheme);
        localStorage.setItem("theme", newTheme);
        document.getElementById("sunIcon").style.display = newTheme === "dark" ? "none" : "block";
        document.getElementById("moonIcon").style.display = newTheme === "dark" ? "block" : "none";
        updateLogo(newTheme);
      }
      function initTheme() {
        const savedTheme = localStorage.getItem("theme") || "light";
        document.documentElement.setAttribute("data-theme", savedTheme);
        if (savedTheme === "dark") { document.getElementById("sunIcon").style.display = "none"; document.getElementById("moonIcon").style.display = "block"; }
        updateLogo(savedTheme);
      }
      document.addEventListener('DOMContentLoaded', () => { initTheme(); loadModels(); document.getElementById("plannedStart").valueAsDate = new Date(); });
    </script>
  </body>
</html>
